#!/bin/bash
#
# Installation:
# sudo curl -fsSL https://raw.githubusercontent.com/deforay/utility-scripts/master/php/switch-php -o /usr/local/bin/switch-php && sudo chmod +x /usr/local/bin/switch-php
#
# Usage:
# sudo switch-php 8.2
# sudo switch-php 8.3 --force
#
# Robust PHP Switcher for Ubuntu
# Idempotent, Resilient, and Safe
#
set -euo pipefail
IFS=$'\n\t'

# --- Configuration ---
LOG_FILE="/var/log/php-switch.log"
LOCK_FILE="/var/lock/php-switch.lock"
RETRIES=3
DELAY=5

# Prevent apt from prompting for user input (needrestart dialogs, etc.)
export DEBIAN_FRONTEND=noninteractive
export NEEDRESTART_MODE=a

# --- Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# --- Helper Functions ---

log() {
    local level="$1"
    local msg="$2"
    local timestamp
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${timestamp} [${level}] ${msg}" | tee -a "$LOG_FILE"
}

info() { log "INFO" "${GREEN}${1}${NC}"; }
warn() { log "WARN" "${YELLOW}${1}${NC}"; }
error() { log "ERROR" "${RED}${1}${NC}"; }
fatal() { log "FATAL" "${RED}${1}${NC}"; exit 1; }

# Retry wrapper for network/lock sensitive commands
run_with_retry() {
    local n=1
    local max=$RETRIES
    local delay=$DELAY
    while true; do
        if "$@"; then
            return 0
        else
            if [[ $n -lt $max ]]; then
                ((n++))
                warn "Command failed. Retrying $n/$max in ${delay}s..."
                sleep $delay
            else
                error "The command has failed after $n attempts."
                return 1
            fi
        fi
    done
}

# --- Pre-flight Checks ---

if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    fatal "Please run as root."
fi

# Acquire lock to prevent concurrent runs
exec 200>"$LOCK_FILE"
flock -n 200 || fatal "Another instance is already running."

# --- Argument Parsing ---

if [[ $# -lt 1 ]]; then
    echo "Usage: $0 <php-version> [options]"
    echo "Example: $0 8.2 --force"
    exit 1
fi

PHP_VERSION="$1"
shift

FORCE_MODE=false
SKIP_UPDATE=false
FAST_MODE=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        -f|--force) FORCE_MODE=true ;;
        --no-update) SKIP_UPDATE=true ;;
        --fast) 
            FAST_MODE=true
            SKIP_UPDATE=true
            ;;
        *) warn "Unknown option: $1" ;;
    esac
    shift
done

if [[ "$FAST_MODE" == "true" ]]; then
    info "Fast mode enabled: skipping apt update and optional extensions."
fi

info "Starting PHP Switch to version: $PHP_VERSION"

# --- System Prep ---

# Ensure basic tools are present (idempotent)
ensure_base_tools() {
    info "Ensuring base tools..."
    # Check if we need to install anything to avoid apt overhead
    if ! dpkg -s software-properties-common curl unzip >/dev/null 2>&1; then
        run_with_retry apt-get update
        run_with_retry apt-get install -y software-properties-common curl unzip acl
    fi
}

# Add PPA safely
setup_ppa() {
    local ppa_name="ondrej/php"
    local ppa_file="/etc/apt/sources.list.d/ondrej-ubuntu-php-$(lsb_release -cs).list"
    
    if [[ ! -f "$ppa_file" ]]; then
        info "Adding PPA: $ppa_name"
        run_with_retry add-apt-repository -y ppa:$ppa_name
        SKIP_UPDATE=false # Force update if we just added PPA
    else
        info "PPA $ppa_name already present."
    fi
}

ensure_base_tools
setup_ppa

if [[ "$SKIP_UPDATE" == "false" ]]; then
    info "Updating package lists..."
    run_with_retry apt-get update
fi

# --- PHP Installation ---

install_php_packages() {
    local version="$1"
    
    # Critical packages - must succeed
    local critical_packages=(
        "php${version}"
        "php${version}-cli"
        "php${version}-common"
        "libapache2-mod-php${version}"
    )

    # Standard Extensions - usually required
    local standard_extensions=(
        "php${version}-curl"
        "php${version}-gd"
        "php${version}-mbstring"
        "php${version}-xml"
        "php${version}-zip"
        "php${version}-mysql"
        "php${version}-bcmath"
        "php${version}-intl"
        "php${version}-gmp"
        "php${version}-opcache"
        "php${version}-sqlite3"
        "php${version}-imagick"
    )

    # Optional Extensions - skipped in fast mode
    local optional_extensions=(
        "php${version}-redis"
        "php${version}-apcu"
        "php${version}-memcached"
    )

    info "Installing PHP $version critical packages..."
    if ! run_with_retry apt-get install -y "${critical_packages[@]}"; then
        fatal "Failed to install critical PHP packages. Aborting."
    fi

    local extensions_to_install=("${standard_extensions[@]}")
    if [[ "$FAST_MODE" == "false" ]]; then
        extensions_to_install+=("${optional_extensions[@]}")
    else
        info "Skipping optional extensions (redis, apcu, memcached)..."
    fi

    info "Installing PHP extensions..."
    # Try batch install first for speed
    if ! apt-get install -y "${extensions_to_install[@]}"; then
        warn "Batch extension install failed. Attempting individual installation..."
        for pkg in "${extensions_to_install[@]}"; do
            # Check if package exists first to avoid apt error noise
            if apt-cache show "$pkg" >/dev/null 2>&1; then
                if ! run_with_retry apt-get install -y "$pkg"; then
                    error "Failed to install $pkg"
                else
                    info "Installed $pkg"
                fi
            else
                warn "Package $pkg not found, skipping."
            fi
        done
    else
        info "All extensions installed successfully."
    fi
}

install_php_packages "$PHP_VERSION"

# --- Configuration (The Idempotent Way) ---

configure_php_tuning() {
    local version="$1"
    local conf_dir="/etc/php/${version}/mods-available"
    local conf_file="${conf_dir}/99-custom-tuning.ini"

    info "Applying PHP configuration tuning..."

    # Create the directory if it doesn't exist (rare)
    mkdir -p "$conf_dir"

    # Write configuration to a separate file.
    # This is idempotent: it overwrites the file with the desired state.
    cat > "$conf_file" <<EOF
; Custom PHP Tuning generated by switch-php
; Do not edit manually, changes will be overwritten.
[PHP]
memory_limit = 512M
upload_max_filesize = 100M
post_max_size = 100M
max_execution_time = 300
date.timezone = UTC
expose_php = Off
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT
display_errors = Off
log_errors = On

[opcache]
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=4000
opcache.revalidate_freq=60
EOF

    # Enable the module for all SAPIs (cli, apache2, fpm)
    # phpenmod is idempotent
    phpenmod -v "$version" 99-custom-tuning
}

configure_php_tuning "$PHP_VERSION"

# --- Apache Switching ---

switch_apache_module() {
    local version="$1"

    if [[ ! -d /etc/apache2 ]]; then
        warn "Apache2 not found, skipping module switch."
        return
    fi

    info "Switching Apache to PHP $version..."

    # Verify module files exist before attempting to enable
    local mod_load="/etc/apache2/mods-available/php${version}.load"
    local mod_conf="/etc/apache2/mods-available/php${version}.conf"

    if [[ ! -f "$mod_load" ]]; then
        warn "Apache PHP module file not found: $mod_load"
        warn "Attempting to reinstall libapache2-mod-php${version}..."

        # Force reinstall the Apache module
        if ! run_with_retry apt-get install --reinstall -y "libapache2-mod-php${version}"; then
            fatal "Failed to install Apache PHP module. Check if libapache2-mod-php${version} exists in repository."
        fi

        # Re-check after reinstall
        if [[ ! -f "$mod_load" ]]; then
            fatal "Apache PHP module file still missing after reinstall: $mod_load. Manual intervention required."
        fi
        info "Apache PHP module reinstalled successfully."
    fi

    # Disable all other PHP modules
    # We find them dynamically to be robust against any installed version
    local current_modules
    current_modules=$(a2query -m 2>/dev/null | grep -oE 'php[0-9]+\.[0-9]+' || true)

    for mod in $current_modules; do
        if [[ "$mod" != "php${version}" ]]; then
            info "Disabling Apache module: $mod"
            a2dismod -f "$mod" 2>/dev/null || true
        fi
    done

    # Enable mpm_prefork if not active (required for mod_php)
    if ! a2query -m mpm_prefork >/dev/null 2>&1; then
        info "Enabling mpm_prefork (required for mod_php)..."
        a2dismod -f mpm_event 2>/dev/null || true
        a2dismod -f mpm_worker 2>/dev/null || true
        if ! a2enmod mpm_prefork; then
            fatal "Failed to enable mpm_prefork. mod_php requires the prefork MPM."
        fi
    fi

    # Enable the target version
    info "Enabling Apache module: php${version}"
    if ! a2enmod "php${version}"; then
        fatal "Failed to enable php${version} Apache module."
    fi

    # Verify module is actually enabled
    if ! a2query -m "php${version}" >/dev/null 2>&1; then
        fatal "php${version} module appears enabled but a2query reports it as inactive."
    fi

    info "Apache PHP module php${version} enabled and verified."
}

switch_apache_module "$PHP_VERSION"

# --- PHP Handler Verification ---

verify_php_handler() {
    local version="$1"

    if [[ ! -d /etc/apache2 ]]; then
        return
    fi

    info "Verifying PHP handler configuration..."

    local handler_conf="/etc/apache2/mods-enabled/php${version}.conf"

    # Check if the handler config symlink exists
    if [[ ! -f "$handler_conf" ]]; then
        warn "PHP handler config not linked in mods-enabled."

        # Check if source exists and try to enable
        if [[ -f "/etc/apache2/mods-available/php${version}.conf" ]]; then
            info "Enabling PHP handler configuration..."
            a2enmod "php${version}" 2>/dev/null || true
        fi
    fi

    # Verify handler directive exists in enabled configs
    local handler_found=false
    if grep -Rq 'SetHandler[[:space:]]\+application/x-httpd-php' /etc/apache2/mods-enabled/ 2>/dev/null; then
        handler_found=true
    elif [[ -f "/etc/apache2/conf-enabled/php${version}-handler.conf" ]]; then
        handler_found=true
    elif [[ -f "/etc/apache2/conf-available/php${version}-handler.conf" ]]; then
        handler_found=true
    fi

    if [[ "$handler_found" == "false" ]]; then
        warn "PHP handler directive not found. Creating fallback handler config..."

        cat > "/etc/apache2/conf-available/php${version}-handler.conf" <<'HANDLER_EOF'
# Fallback PHP handler created by switch-php
<FilesMatch "\.php$">
    SetHandler application/x-httpd-php
</FilesMatch>
<FilesMatch "\.phps$">
    SetHandler application/x-httpd-php-source
</FilesMatch>
HANDLER_EOF

        if a2enconf "php${version}-handler" 2>/dev/null; then
            info "Fallback PHP handler enabled."
        else
            error "Failed to enable fallback PHP handler."
        fi
    else
        info "PHP handler configuration verified."
    fi
}

verify_php_handler "$PHP_VERSION"

# --- CLI Alternatives ---

update_alternatives() {
    local version="$1"
    info "Updating CLI alternatives..."
    
    if [[ -f "/usr/bin/php${version}" ]]; then
        update-alternatives --set php "/usr/bin/php${version}"
        update-alternatives --set phar "/usr/bin/phar${version}" 2>/dev/null || true
        update-alternatives --set phar.phar "/usr/bin/phar.phar${version}" 2>/dev/null || true
    else
        error "Binary /usr/bin/php${version} not found!"
    fi
}

update_alternatives "$PHP_VERSION"

# --- Composer ---

install_composer() {
    if command -v composer >/dev/null 2>&1 && [[ "$FORCE_MODE" == "false" ]]; then
        info "Composer already installed."
        return
    fi

    info "Installing/Updating Composer..."
    EXPECTED_CHECKSUM="$(php -r 'copy("https://composer.github.io/installer.sig", "php://stdout");')"
    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    ACTUAL_CHECKSUM="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"

    if [[ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]]; then
        rm composer-setup.php
        error "Composer installer corrupt"
        return 1
    fi

    php composer-setup.php --quiet --install-dir=/usr/local/bin --filename=composer
    rm composer-setup.php
    chmod +x /usr/local/bin/composer
}

install_composer

# --- Restart Services ---

restart_apache_safe() {
    if [[ ! -d /etc/apache2 ]]; then return; fi

    info "Restarting Apache..."
    
    # 1. Syntax check first
    if ! apache2ctl -t; then
        error "Apache configuration syntax error! Not restarting to prevent downtime."
        return 1
    fi

    # 2. Robust restart with timeout and kill
    # Try polite restart (20s), then force kill (10s later)
    if ! timeout -k 10 20 systemctl restart apache2; then
        error "Apache failed to restart gracefully. Check logs."
        systemctl status apache2 --no-pager | tail -n 20
        return 1
    fi
    
    info "Apache restarted successfully."
}

restart_apache_safe

# --- PHP Processing Verification ---

verify_php_working() {
    if [[ ! -d /etc/apache2 ]]; then
        return 0
    fi

    # Find a web root to test in
    local web_root="/var/www/html"
    if [[ ! -d "$web_root" ]]; then
        # Try to find DocumentRoot from Apache config
        web_root=$(grep -rh "DocumentRoot" /etc/apache2/sites-enabled/ 2>/dev/null | head -1 | awk '{print $2}' | tr -d '"')
        if [[ -z "$web_root" || ! -d "$web_root" ]]; then
            warn "Cannot determine web root for PHP verification test."
            return 0
        fi
    fi

    # Try to honor the first ServerName/ServerAlias as Host header to avoid vhost mismatch/redirects
    local server_name
    server_name=$(grep -Eh "^\s*Server(Name|Alias)" /etc/apache2/sites-enabled/*.conf 2>/dev/null | awk '{print $2}' | head -1 | tr -d '"')

    # Avoid dotfiles; Apache default security rules often block them.
    local test_file="${web_root}/php-switch-test-$$.php"
    local test_token="PHP_SWITCH_OK_$$"

    info "Running PHP processing verification (web root: ${web_root}${server_name:+, Host: ${server_name}})..."

    # Create test file
    echo "<?php echo '${test_token}'; ?>" > "$test_file"
    chmod 644 "$test_file"

    # Give Apache a moment to fully initialize
    sleep 1

    # Test via curl if available
    if command -v curl >/dev/null 2>&1; then
        local headers_file body_file status_code url response location_header
        local -a host_header=()
        headers_file=$(mktemp)
        body_file=$(mktemp)
        url="http://127.0.0.1/$(basename "$test_file")"

        if [[ -n "$server_name" ]]; then
            host_header=(-H "Host: ${server_name}")
        fi

        status_code=$(curl -s -L --max-time 8 -o "$body_file" -D "$headers_file" -w '%{http_code}' "${host_header[@]}" --insecure "$url" 2>/dev/null || true)
        response=$(head -c 200 "$body_file")
        location_header=$(grep -i '^Location:' "$headers_file" | tail -1 | cut -d' ' -f2- | tr -d '\r')

        rm -f "$test_file" "$headers_file" "$body_file"

        if [[ "$response" == *"$test_token"* ]]; then
            info "PHP verification: PASSED - PHP code is being processed correctly."
            return 0
        elif [[ "$response" == *"<?php"* ]]; then
            error "PHP verification: FAILED - PHP code is NOT being processed!"
            error "Apache is serving raw PHP source code instead of executing it."
            error "Possible causes:"
            error "  1. PHP module not loaded (check: a2query -m | grep php)"
            error "  2. Missing PHP handler in Apache config"
            error "  3. MPM module conflict (mod_php requires mpm_prefork)"
            return 1
        else
            warn "PHP verification: INCONCLUSIVE - HTTP ${status_code}${location_header:+, Location: ${location_header}}."
            warn "Response (first 200 chars): ${response}"
            if [[ -n "$server_name" ]]; then
                warn "Tip: verification uses Host '${server_name}'. If your site forces HTTPS or another hostname, check that apache serves ${url} with that Host header."
            else
                warn "Tip: could be a redirect/virtual host mismatch. Configure ServerName or run curl manually to debug."
            fi
            return 0
        fi
    else
        rm -f "$test_file"
        warn "curl not available, skipping PHP processing verification."
        return 0
    fi
}

# Do not hard-fail the whole switch if the HTTP check fails; surface a warning instead.
verify_php_working || warn "PHP HTTP verification failed; check web root/virtual host setup. See ${LOG_FILE} for details."

# --- Final Report ---

info "--------------------------------------------------"
info "PHP Switch Complete"
info "Current CLI Version: $(php -r 'echo PHP_VERSION;')"
if [[ -d /etc/apache2 ]]; then
    info "Apache Module: $(a2query -m | grep 'php' || echo 'None')"
fi
info "--------------------------------------------------"

exit 0
