#!/bin/bash
set -euo pipefail

# To use this script:
# sudo wget https://raw.githubusercontent.com/deforay/utility-scripts/master/php/switch-php -O /usr/local/bin/switch-php
# sudo chmod +x /usr/local/bin/switch-php
# sudo switch-php 7.4
# sudo switch-php 8.2
# sudo switch-php 8.3
# sudo switch-php 8.2 -f
# sudo switch-php 8.2 --force

# Root check
if [ "${EUID:-$(id -u)}" -ne 0 ]; then
  echo "Please run as root."
  exit 1
fi

# Ubuntu 20.04+
check_ubuntu_version() {
  . /etc/os-release
  if [ "${ID:-}" != "ubuntu" ]; then
    echo "This script is intended for Ubuntu."
    exit 1
  fi
  VERSION_MAJOR="${VERSION_ID%.*}"
  if [ "${VERSION_MAJOR:-0}" -lt 20 ]; then
    echo "This script requires Ubuntu 20.04 or higher."
    exit 1
  fi
}
check_ubuntu_version

# Fresh log for this run
LOG_FILE="/var/log/php-switch-error.log"
# echo "PHP switch run $(date -Is)" > "$LOG_FILE"
chmod 0644 "$LOG_FILE" || true

# Parse arguments
if [ $# -lt 1 ]; then
  echo "Provide PHP version (e.g., 7.4, 8.0, 8.1, 8.2, 8.3)"
  echo "Options:"
  echo "  -f, --force         Force reinstall PHP, extensions, and Composer"
  echo "      --fast          Skip apt upgrade/base package install/optional extensions"
  echo "      --no-optional   Skip optional extensions (apcu, memcached, redis)"
  echo "      --no-upgrade    Skip apt-get upgrade/autoremove step"
  echo "      --no-update     Skip apt-get update (useful on air-gapped/slow hosts)"
  echo "      --skip-base     Skip base dependency install"
  echo "      --no-composer-update  Skip Composer self-update to the latest v2 release"
  exit 1
fi

PHP_VERSION="$1"
shift

FORCE_MODE=false
FAST_MODE=false
SKIP_OPTIONAL_EXT=false
SKIP_UPGRADE=false
SKIP_BASE_PACKAGES=false
UPDATE_COMPOSER=true
RUN_APT_UPDATE=true
APT_UPDATED=false

while [ $# -gt 0 ]; do
  case "$1" in
    -f|--force)
      FORCE_MODE=true
      echo "Force mode enabled: will reinstall PHP, extensions, and Composer"
      ;;
    --fast)
      FAST_MODE=true
      SKIP_OPTIONAL_EXT=true
      SKIP_UPGRADE=true
      SKIP_BASE_PACKAGES=true
      RUN_APT_UPDATE=false
      echo "Fast mode enabled: skipping apt-get update/upgrade, base packages, and optional extensions"
      ;;
    --no-optional)
      SKIP_OPTIONAL_EXT=true
      ;;
    --no-upgrade)
      SKIP_UPGRADE=true
      ;;
    --skip-base)
      SKIP_BASE_PACKAGES=true
      ;;
    --no-update)
      RUN_APT_UPDATE=false
      ;;
    --no-composer-update)
      UPDATE_COMPOSER=false
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
  shift
done

apt_update() {
  local force="${1:-false}"
  if [ "$RUN_APT_UPDATE" = false ]; then
    echo "Skipping apt-get update (--fast/--no-update)"
    return 0
  fi
  if [ "$force" != "true" ] && [ "$APT_UPDATED" = "true" ]; then
    return 0
  fi
  apt-get update
  APT_UPDATED=true
}

restart_apache() {
  echo "Restarting Apache..."
  if timeout 20 service apache2 restart; then
    return 0
  fi
  echo "⚠ Apache restart timed out or failed; attempting systemctl restart" | tee -a "$LOG_FILE"
  timeout 20 systemctl restart apache2 || echo "⚠ systemctl restart apache2 also failed" | tee -a "$LOG_FILE"
}

# Refresh base packages
apt_update
if [ "$SKIP_UPGRADE" = false ]; then
  apt-get -y upgrade
  apt-get -y autoremove
fi
dpkg --configure -a

if [ "$SKIP_BASE_PACKAGES" = false ]; then
  apt-get install -y --no-install-recommends \
    build-essential software-properties-common gnupg apt-transport-https \
    ca-certificates lsb-release wget vim zip unzip curl acl snapd rsync git \
    gdebi net-tools sed mawk magic-wormhole openssh-server libsodium-dev \
    mosh aria2 imagemagick
fi

ensure_ppa() {
  local ppa="$1" pattern="$2"
  if ls /etc/apt/sources.list.d/${pattern} >/dev/null 2>&1; then
    echo "✓ ${ppa} already present"
    return 0
  fi
  echo "Adding ${ppa}..."
  LC_ALL=C.UTF-8 add-apt-repository -y "${ppa}" || true
}

# Add Ondřej's PPAs (idempotent) and update
ensure_ppa "ppa:ondrej/php" "ondrej-ubuntu-php*"
ensure_ppa "ppa:ondrej/apache2" "ondrej-ubuntu-apache2*"
apt_update true

# Verify PPA presence
if ! ls /etc/apt/sources.list.d/ondrej-ubuntu-php* >/dev/null 2>&1; then
  echo "⚠ Ondřej PHP PPA list file not found"
fi

# Prefer PPA packages
cat >/etc/apt/preferences.d/ondrej-php.pref <<'EOF'
Package: php*
Pin: release o=LP-PPA-ondrej-php
Pin-Priority: 700

Package: apache2*
Pin: release o=LP-PPA-ondrej-apache2
Pin-Priority: 700
EOF
apt_update true

# Force apt to pick from the PPA when available
APT_PPA_TARGET="-t o=LP-PPA-ondrej-php"

# Helpers
package_exists() { apt-cache show "$1" >/dev/null 2>&1; }

install_with_fallback() {
  local pkg="$1" label="${2:-$1}" allow_missing="${3:-false}"
  if apt-get install -y $APT_PPA_TARGET "$pkg"; then
    echo "✓ Installed ${label}"
    return 0
  fi

  echo "⚠ ${label} install via PPA target failed, retrying without pin" | tee -a /var/log/php-switch-error.log
  if apt-get install -y "$pkg"; then
    echo "✓ Installed ${label}"
    return 0
  fi

  if [ "$allow_missing" = true ]; then
    echo "⚠ ${label} not available; continuing" | tee -a /var/log/php-switch-error.log
    return 0
  fi

  echo "✗ Failed to install ${label}" | tee -a /var/log/php-switch-error.log
  return 1
}

ensure_package_installed() {
  local pkg="$1" label="${2:-$1}"
  if [ "$FORCE_MODE" = false ] && dpkg -s "$pkg" >/dev/null 2>&1; then
    echo "✓ ${label} already installed"
    return 0
  fi

  echo "Installing ${label}..."
  install_with_fallback "$pkg" "$label"
}

# Ensure base PHP + Apache module
ensure_package_installed "php${PHP_VERSION}" "PHP ${PHP_VERSION}"
apache_module_pkg="libapache2-mod-php${PHP_VERSION}"
if ! ensure_package_installed "$apache_module_pkg" "$apache_module_pkg"; then
  echo "⚠ ${apache_module_pkg} install failed; checking availability..." | tee -a /var/log/php-switch-error.log
  if ! package_exists "$apache_module_pkg"; then
    echo "⚠ ${apache_module_pkg} not found in apt cache (PPA may not have this version yet)" | tee -a /var/log/php-switch-error.log
  fi
  apt-cache policy "$apache_module_pkg" >>/var/log/php-switch-error.log 2>&1 || true
fi

install_extension() {
  local ext_name="$1"
  local pkg="php${PHP_VERSION}-${ext_name}"

  # Special-case redis - try versioned package first to avoid pulling in latest PHP version
  if [ "$ext_name" = "redis" ]; then
    if ! php -m | grep -qi '^redis$' || [ "$FORCE_MODE" = true ]; then
      echo "Installing php${PHP_VERSION}-redis..."
      # Try versioned package first (php8.4-redis)
      if package_exists "php${PHP_VERSION}-redis" && apt-get install -y $APT_PPA_TARGET "php${PHP_VERSION}-redis"; then
        echo "✓ redis installed (versioned package)"
        return 0
      fi
      # Fallback to unversioned if versioned doesn't exist (may pull latest PHP)
      echo "⚠ Versioned redis not available, trying unversioned php-redis" | tee -a /var/log/php-switch-error.log
      if apt-get install -y $APT_PPA_TARGET php-redis; then
        echo "✓ redis installed (unversioned package - may have pulled newer PHP)" | tee -a /var/log/php-switch-error.log
        return 0
      fi
      echo "⚠ Failed to install redis" >>/var/log/php-switch-error.log
      return 0
    fi
    echo "✓ redis already loaded"
    return 0
  fi

  # Normal versioned package path
  if [ "$FORCE_MODE" = false ] && dpkg -l | grep -q "^ii\s\+${pkg}\s"; then
    echo "✓ ${pkg} already installed"
    return 0
  fi

  echo "Installing ${pkg}..."
  if package_exists "${pkg}"; then
    if install_with_fallback "${pkg}" "${pkg}"; then
      return 0
    fi
  fi

  # sqlite3 may be missing for some PHP/Ubuntu combos on focal
  if [ "$ext_name" = "sqlite3" ]; then
    echo "⚠ ${pkg} not available from PPA on this release" | tee -a /var/log/php-switch-error.log
    echo "  → Consider PHP 8.3 on focal (php8.3-sqlite3) or upgrade to Ubuntu 22.04/24.04." | tee -a /var/log/php-switch-error.log
    echo "  → Continuing installation without sqlite3..." | tee -a /var/log/php-switch-error.log
    return 0
  fi

  echo "⚠ Could not install ${pkg}" | tee -a /var/log/php-switch-error.log
  return 0
}

# Core extensions (keep names that actually exist)
extensions=(
  common
  cli
  mysql      # provides pdo_mysql + mysqli
  zip
  gd
  mbstring
  curl
  xml
  bcmath
  gmp
  intl
  opcache
  sqlite3    # may be absent for PHP 8.2 on focal; handled in install_extension()
)

optional_extensions=(
  apcu
  memcached
  redis
)

echo "Installing core PHP extensions..."
for ext in "${extensions[@]}"; do
  install_extension "$ext" || true
done

echo "Installing optional PHP extensions..."
if [ "$SKIP_OPTIONAL_EXT" = false ]; then
  for ext in "${optional_extensions[@]}"; do
    install_extension "$ext" || true
  done
else
  echo "Skipping optional extensions (apcu, memcached, redis)"
fi

# Imagick - prefer versioned package to avoid pulling latest PHP version
echo "Installing php${PHP_VERSION}-imagick..."
if package_exists "php${PHP_VERSION}-imagick" && apt-get install -y $APT_PPA_TARGET "php${PHP_VERSION}-imagick"; then
  echo "✓ imagick installed (versioned)"
elif apt-get install -y $APT_PPA_TARGET php-imagick; then
  echo "⚠ Installed unversioned php-imagick (may have pulled newer PHP)" | tee -a /var/log/php-switch-error.log
else
  echo "⚠ php-imagick failed" >>/var/log/php-switch-error.log
fi

# Apache module switch
echo "Configuring Apache for PHP ${PHP_VERSION}..."
if [ ! -x /usr/sbin/a2enmod ] || [ ! -d /etc/apache2 ]; then
    echo "Apache2 not detected; installing apache2 for mod_php support..."
    ensure_package_installed apache2 "apache2 web server" || echo "⚠ apache2 install failed" | tee -a "$LOG_FILE"
fi

if [ -x /usr/sbin/a2enmod ] && [ -d /etc/apache2 ]; then
    enabled_php_versions=$(ls /etc/apache2/mods-enabled/ 2>/dev/null | grep -oP '^php\d\.\d' | sort -u || true)
    for ev in $enabled_php_versions; do
        if [ "$ev" != "php${PHP_VERSION}" ]; then
            echo "Disabling $ev"
            a2dismod "$ev" || true
        fi
    done

    mod_load_file="/etc/apache2/mods-available/php${PHP_VERSION}.load"
    if [ ! -f "$mod_load_file" ]; then
        echo "⚠ Apache module php${PHP_VERSION} not found; reinstalling apache module package..."
        # Reinstall explicitly in case dpkg database thinks it's already present
        if ! apt-get install -y --reinstall $APT_PPA_TARGET "libapache2-mod-php${PHP_VERSION}"; then
            echo "⚠ Reinstall via PPA pin failed, retrying without pin" | tee -a "$LOG_FILE"
            apt-get install -y --reinstall "libapache2-mod-php${PHP_VERSION}" || true
        fi
        apt-cache policy "libapache2-mod-php${PHP_VERSION}" >>"$LOG_FILE" 2>&1 || true
    fi

    if [ -f "$mod_load_file" ]; then
        echo "Enabling php${PHP_VERSION} module"
        if ! a2enmod "php${PHP_VERSION}"; then
            echo "⚠ Failed to enable php${PHP_VERSION} module" | tee -a "$LOG_FILE"
        fi
    else
        echo "⚠ Apache module php${PHP_VERSION} still missing after reinstall" | tee -a "$LOG_FILE"
    fi
else
    echo "⚠ Apache2 not detected; skipping Apache module configuration" | tee -a "$LOG_FILE"
fi

# CLI alternatives
echo "Setting PHP ${PHP_VERSION} as default CLI..."
update-alternatives --set php "/usr/bin/php${PHP_VERSION}" || true
update-alternatives --set phar "/usr/bin/phar${PHP_VERSION}" 2>/dev/null || true
update-alternatives --set phar.phar "/usr/bin/phar.phar${PHP_VERSION}" 2>/dev/null || true

# php.ini tweaks
CLI_PHP_INI="/etc/php/${PHP_VERSION}/cli/php.ini"
if [ -f "$CLI_PHP_INI" ] && ! grep -q "apc.enable_cli=1" "$CLI_PHP_INI"; then
    echo "apc.enable_cli=1" >>"$CLI_PHP_INI"
fi

restart_apache || true

echo "✓ Switched to PHP ${PHP_VERSION}"
echo "✓ PHP CLI version switched"

# Config tuning
echo "Configuring PHP settings..."
TOTAL_RAM_KB=$(awk '/MemTotal/ {print $2}' /proc/meminfo || echo 0)
if [ "$TOTAL_RAM_KB" -gt 0 ]; then
  RAM_75_MB=$((TOTAL_RAM_KB * 3 / 4 / 1024))
    MEMORY_LIMIT="${RAM_75_MB}M"
else
    MEMORY_LIMIT="1024M"
fi

desired_error_reporting="error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT & ~E_NOTICE & ~E_WARNING"
desired_post_max_size="post_max_size = 1G"
desired_upload_max_filesize="upload_max_filesize = 1G"
desired_memory_limit="memory_limit = ${MEMORY_LIMIT}"
desired_strict_mode="session.use_strict_mode = 1"
desired_max_execution_time="max_execution_time = 300"

for phpini in "/etc/php/${PHP_VERSION}/apache2/php.ini" "/etc/php/${PHP_VERSION}/cli/php.ini"; do
    [ -f "$phpini" ] || continue
    echo "Updating $phpini..."
    awk -v er="$desired_error_reporting" -v pms="$desired_post_max_size" \
        -v umf="$desired_upload_max_filesize" -v ml="$desired_memory_limit" \
        -v dsm="$desired_strict_mode" -v met="$desired_max_execution_time" \
        '{
            if ($0 ~ /^error_reporting[[:space:]]*=/)         {print ";" $0 "\n" er;  next}
            if ($0 ~ /^post_max_size[[:space:]]*=/)           {print ";" $0 "\n" pms; next}
            if ($0 ~ /^upload_max_filesize[[:space:]]*=/)     {print ";" $0 "\n" umf; next}
            if ($0 ~ /^memory_limit[[:space:]]*=/)            {print ";" $0 "\n" ml;  next}
            if ($0 ~ /^session\.use_strict_mode[[:space:]]*=/){print ";" $0 "\n" dsm; next}
            if ($0 ~ /^max_execution_time[[:space:]]*=/)      {print ";" $0 "\n" met; next}
            print $0
        }' "$phpini" >"${phpini}.tmp" && mv "${phpini}.tmp" "$phpini"
done

# Composer (global, verified)
COMPOSER_TIMEOUT=60

install_composer_global() {
    echo "Installing Composer (verified)…"
    local installer sig actual
    sig="$(curl -fsSL --max-time 60 https://composer.github.io/installer.sig)" || {
        echo "Failed to fetch Composer installer signature."
        return 1
    }
    installer="$(mktemp)"
    curl -fsSL --max-time 60 https://getcomposer.org/installer -o "$installer" || {
        echo "Failed to download Composer installer."
        rm -f "$installer"
        return 1
    }
    actual="$(php -r "echo hash_file('sha384', '${installer}');")"
    if [ "$sig" != "$actual" ]; then
        echo "Composer installer signature mismatch. Aborting."
        rm -f "$installer"
        return 1
    fi
    # Use timeout to prevent hanging if the PHP script stalls
    timeout "$COMPOSER_TIMEOUT" php "$installer" --no-ansi --install-dir=/usr/local/bin --filename=composer || {
        echo "Composer installation failed or timed out."
        rm -f "$installer"
        return 1
    }
    rm -f "$installer"
    chmod 755 /usr/local/bin/composer
    # Ensure cron/systemd (often lacking /usr/local/bin) can find it:
    if [ -w /usr/bin ] && [ ! -e /usr/bin/composer ]; then
        ln -sf /usr/local/bin/composer /usr/bin/composer
    fi
    echo "✓ Composer installed at $(/usr/local/bin/composer -V 2>/dev/null || echo /usr/local/bin/composer)"
}

update_composer_major2() {
    [ "$UPDATE_COMPOSER" = true ] || return 0
    command -v composer >/dev/null 2>&1 || return 0
    
    # Skip update if composer was just installed (version 2.9+ is current)
    local current_version
    current_version=$(composer --version 2>/dev/null | grep -oP '\d+\.\d+\.\d+' | head -1)
    if [[ "$current_version" =~ ^2\.[89]\. ]]; then
        echo "✓ Composer ${current_version} is recent, skipping self-update"
        return 0
    fi
    
    echo "Updating Composer to latest v2…"
    
    # Set environment variables to suppress interactive warnings
    export COMPOSER_ALLOW_SUPERUSER=1
    export COMPOSER_NO_INTERACTION=1
    
    # Show output to prevent appearance of hanging
    if timeout "$COMPOSER_TIMEOUT" composer self-update --2 --no-interaction 2>&1; then
        echo "✓ Composer now $(composer --version 2>/dev/null || echo 'updated')"
        return 0
    fi
    
    local exit_code=$?
    if [ $exit_code -eq 124 ]; then
        echo "⚠ Composer self-update timed out after ${COMPOSER_TIMEOUT}s" | tee -a "$LOG_FILE"
    else
        echo "⚠ Composer self-update failed (exit code: $exit_code)" | tee -a "$LOG_FILE"
    fi
    
    # Verify composer is still functional after failed update
    if composer --version >/dev/null 2>&1; then
        echo "✓ Composer is still functional at version: $(composer --version)" | tee -a "$LOG_FILE"
    else
        echo "⚠ Composer may be corrupted, attempting reinstall..." | tee -a "$LOG_FILE"
        rm -f /usr/local/bin/composer /usr/bin/composer
        install_composer_global || echo "⚠ Composer reinstall failed" | tee -a "$LOG_FILE"
    fi
}

# Composer
if [ "$FORCE_MODE" = true ] || ! command -v composer >/dev/null 2>&1; then
    echo "Setting up Composer (force=${FORCE_MODE})…"
    if [ "$FORCE_MODE" = true ] && [ -f /usr/local/bin/composer ]; then
        rm -f /usr/local/bin/composer
    fi
    install_composer_global || echo "⚠ Composer setup encountered an issue"
else
    echo "✓ Composer already installed (use --force to reinstall)"
fi
update_composer_major2

# Final restart
echo "Final Apache restart..."
restart_apache || true

echo
if [ -f /var/log/php-switch-error.log ]; then
    echo "Installation Issues Found:"
    echo "------------------------"
    cat /var/log/php-switch-error.log || true
else
    echo "✓ No installation errors detected"
fi

echo
echo
echo "Installation complete! PHP ${PHP_VERSION} is now active."
echo

exit 0
