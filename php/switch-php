#!/bin/bash
#
# Installation:
# sudo curl -fsSL https://raw.githubusercontent.com/deforay/utility-scripts/master/php/switch-php -o /usr/local/bin/switch-php && sudo chmod +x /usr/local/bin/switch-php
#
# Usage:
# sudo switch-php 8.2
# sudo switch-php 8.3 --force
#
# Robust PHP Switcher for Ubuntu
# Idempotent, Resilient, and Safe
#
set -euo pipefail
IFS=$'\n\t'

# --- Configuration ---
LOG_FILE="/var/log/php-switch.log"
LOCK_FILE="/var/lock/php-switch.lock"
DEBIAN_FRONTEND=noninteractive
RETRIES=3
DELAY=5

# --- Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# --- Helper Functions ---

log() {
    local level="$1"
    local msg="$2"
    local timestamp
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "${timestamp} [${level}] ${msg}" | tee -a "$LOG_FILE"
}

info() { log "INFO" "${GREEN}${1}${NC}"; }
warn() { log "WARN" "${YELLOW}${1}${NC}"; }
error() { log "ERROR" "${RED}${1}${NC}"; }
fatal() { log "FATAL" "${RED}${1}${NC}"; exit 1; }

# Retry wrapper for network/lock sensitive commands
run_with_retry() {
    local n=1
    local max=$RETRIES
    local delay=$DELAY
    while true; do
        if "$@"; then
            return 0
        else
            if [[ $n -lt $max ]]; then
                ((n++))
                warn "Command failed. Retrying $n/$max in ${delay}s..."
                sleep $delay
            else
                error "The command has failed after $n attempts."
                return 1
            fi
        fi
    done
}

# --- Pre-flight Checks ---

if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    fatal "Please run as root."
fi

# Acquire lock to prevent concurrent runs
exec 200>"$LOCK_FILE"
flock -n 200 || fatal "Another instance is already running."

# --- Argument Parsing ---

if [[ $# -lt 1 ]]; then
    echo "Usage: $0 <php-version> [options]"
    echo "Example: $0 8.2 --force"
    exit 1
fi

PHP_VERSION="$1"
shift

FORCE_MODE=false
SKIP_UPDATE=false
FAST_MODE=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        -f|--force) FORCE_MODE=true ;;
        --no-update) SKIP_UPDATE=true ;;
        --fast) 
            FAST_MODE=true
            SKIP_UPDATE=true
            ;;
        *) warn "Unknown option: $1" ;;
    esac
    shift
done

if [[ "$FAST_MODE" == "true" ]]; then
    info "Fast mode enabled: skipping apt update and optional extensions."
fi

info "Starting PHP Switch to version: $PHP_VERSION"

# --- System Prep ---

# Ensure basic tools are present (idempotent)
ensure_base_tools() {
    info "Ensuring base tools..."
    # Check if we need to install anything to avoid apt overhead
    if ! dpkg -s software-properties-common curl unzip >/dev/null 2>&1; then
        run_with_retry apt-get update
        run_with_retry apt-get install -y software-properties-common curl unzip acl
    fi
}

# Add PPA safely
setup_ppa() {
    local ppa_name="ondrej/php"
    local ppa_file="/etc/apt/sources.list.d/ondrej-ubuntu-php-$(lsb_release -cs).list"
    
    if [[ ! -f "$ppa_file" ]]; then
        info "Adding PPA: $ppa_name"
        run_with_retry add-apt-repository -y ppa:$ppa_name
        SKIP_UPDATE=false # Force update if we just added PPA
    else
        info "PPA $ppa_name already present."
    fi
}

ensure_base_tools
setup_ppa

if [[ "$SKIP_UPDATE" == "false" ]]; then
    info "Updating package lists..."
    run_with_retry apt-get update
fi

# --- PHP Installation ---

install_php_packages() {
    local version="$1"
    
    # Critical packages - must succeed
    local critical_packages=(
        "php${version}"
        "php${version}-cli"
        "php${version}-common"
        "libapache2-mod-php${version}"
    )

    # Standard Extensions - usually required
    local standard_extensions=(
        "php${version}-curl"
        "php${version}-gd"
        "php${version}-mbstring"
        "php${version}-xml"
        "php${version}-zip"
        "php${version}-mysql"
        "php${version}-bcmath"
        "php${version}-intl"
        "php${version}-gmp"
        "php${version}-opcache"
        "php${version}-sqlite3"
        "php${version}-imagick"
    )

    # Optional Extensions - skipped in fast mode
    local optional_extensions=(
        "php${version}-redis"
        "php${version}-apcu"
        "php${version}-memcached"
    )

    info "Installing PHP $version critical packages..."
    if ! run_with_retry apt-get install -y "${critical_packages[@]}"; then
        fatal "Failed to install critical PHP packages. Aborting."
    fi

    local extensions_to_install=("${standard_extensions[@]}")
    if [[ "$FAST_MODE" == "false" ]]; then
        extensions_to_install+=("${optional_extensions[@]}")
    else
        info "Skipping optional extensions (redis, apcu, memcached)..."
    fi

    info "Installing PHP extensions..."
    # Try batch install first for speed
    if ! apt-get install -y "${extensions_to_install[@]}"; then
        warn "Batch extension install failed. Attempting individual installation..."
        for pkg in "${extensions_to_install[@]}"; do
            # Check if package exists first to avoid apt error noise
            if apt-cache show "$pkg" >/dev/null 2>&1; then
                if ! run_with_retry apt-get install -y "$pkg"; then
                    error "Failed to install $pkg"
                else
                    info "Installed $pkg"
                fi
            else
                warn "Package $pkg not found, skipping."
            fi
        done
    else
        info "All extensions installed successfully."
    fi
}

install_php_packages "$PHP_VERSION"

# --- Configuration (The Idempotent Way) ---

configure_php_tuning() {
    local version="$1"
    local conf_dir="/etc/php/${version}/mods-available"
    local conf_file="${conf_dir}/99-custom-tuning.ini"

    info "Applying PHP configuration tuning..."

    # Create the directory if it doesn't exist (rare)
    mkdir -p "$conf_dir"

    # Write configuration to a separate file.
    # This is idempotent: it overwrites the file with the desired state.
    cat > "$conf_file" <<EOF
; Custom PHP Tuning generated by switch-php
; Do not edit manually, changes will be overwritten.
[PHP]
memory_limit = 512M
upload_max_filesize = 100M
post_max_size = 100M
max_execution_time = 300
date.timezone = UTC
expose_php = Off
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT
display_errors = Off
log_errors = On

[opcache]
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=4000
opcache.revalidate_freq=60
EOF

    # Enable the module for all SAPIs (cli, apache2, fpm)
    # phpenmod is idempotent
    phpenmod -v "$version" 99-custom-tuning
}

configure_php_tuning "$PHP_VERSION"

# --- Apache Switching ---

switch_apache_module() {
    local version="$1"
    
    if [[ ! -d /etc/apache2 ]]; then
        warn "Apache2 not found, skipping module switch."
        return
    fi

    info "Switching Apache to PHP $version..."

    # Disable all other PHP modules
    # We find them dynamically to be robust against any installed version
    local current_modules
    current_modules=$(a2query -m | grep -o 'php[0-9]\.[0-9]' || true)

    for mod in $current_modules; do
        if [[ "$mod" != "php${version}" ]]; then
            info "Disabling Apache module: $mod"
            a2dismod -f "$mod" || true
        fi
    done

    # Enable mpm_prefork if not active (required for mod_php)
    if ! a2query -m mpm_prefork >/dev/null 2>&1; then
        info "Enabling mpm_prefork..."
        a2dismod -f mpm_event mpm_worker || true
        a2enmod mpm_prefork || true
    fi

    # Enable the target version
    info "Enabling Apache module: php${version}"
    a2enmod "php${version}"
}

switch_apache_module "$PHP_VERSION"

# --- CLI Alternatives ---

update_alternatives() {
    local version="$1"
    info "Updating CLI alternatives..."
    
    if [[ -f "/usr/bin/php${version}" ]]; then
        update-alternatives --set php "/usr/bin/php${version}"
        update-alternatives --set phar "/usr/bin/phar${version}" 2>/dev/null || true
        update-alternatives --set phar.phar "/usr/bin/phar.phar${version}" 2>/dev/null || true
    else
        error "Binary /usr/bin/php${version} not found!"
    fi
}

update_alternatives "$PHP_VERSION"

# --- Composer ---

install_composer() {
    if command -v composer >/dev/null 2>&1 && [[ "$FORCE_MODE" == "false" ]]; then
        info "Composer already installed."
        return
    fi

    info "Installing/Updating Composer..."
    EXPECTED_CHECKSUM="$(php -r 'copy("https://composer.github.io/installer.sig", "php://stdout");')"
    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    ACTUAL_CHECKSUM="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"

    if [[ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]]; then
        rm composer-setup.php
        error "Composer installer corrupt"
        return 1
    fi

    php composer-setup.php --quiet --install-dir=/usr/local/bin --filename=composer
    rm composer-setup.php
    chmod +x /usr/local/bin/composer
}

install_composer

# --- Restart Services ---

restart_apache_safe() {
    if [[ ! -d /etc/apache2 ]]; then return; fi

    info "Restarting Apache..."
    
    # 1. Syntax check first
    if ! apache2ctl -t; then
        error "Apache configuration syntax error! Not restarting to prevent downtime."
        return 1
    fi

    # 2. Robust restart with timeout and kill
    # Try polite restart (20s), then force kill (10s later)
    if ! timeout -k 10 20 systemctl restart apache2; then
        error "Apache failed to restart gracefully. Check logs."
        systemctl status apache2 --no-pager | tail -n 20
        return 1
    fi
    
    info "Apache restarted successfully."
}

restart_apache_safe

# --- Final Report ---

info "--------------------------------------------------"
info "PHP Switch Complete"
info "Current CLI Version: $(php -r 'echo PHP_VERSION;')"
if [[ -d /etc/apache2 ]]; then
    info "Apache Module: $(a2query -m | grep 'php' || echo 'None')"
fi
info "--------------------------------------------------"

exit 0
